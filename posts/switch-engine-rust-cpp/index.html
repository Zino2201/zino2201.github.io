<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Why I switched my game engine from C++ to Rust" /><meta property="og:locale" content="en" /><meta name="description" content="Introduction I started programming in C++ six years ago, starting with a few toy projects on Unreal Engine 4. I had a small experience before, having programmed in C#, Java, Python but, C++ really hooked me up for several reasons: The art of pointers The power of template metaprogramming The really big ecosystem of libraries, tools, etc And flexing about me doing C++! (but on Windows, no archlinux vim setup sorry!)" /><meta property="og:description" content="Introduction I started programming in C++ six years ago, starting with a few toy projects on Unreal Engine 4. I had a small experience before, having programmed in C#, Java, Python but, C++ really hooked me up for several reasons: The art of pointers The power of template metaprogramming The really big ecosystem of libraries, tools, etc And flexing about me doing C++! (but on Windows, no archlinux vim setup sorry!)" /><link rel="canonical" href="https://zino2201.github.io/posts/switch-engine-rust-cpp/" /><meta property="og:url" content="https://zino2201.github.io/posts/switch-engine-rust-cpp/" /><meta property="og:site_name" content="Zino" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-05-02T15:40:00+00:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Why I switched my game engine from C++ to Rust" /><meta name="twitter:site" content="@Zino2201_" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-05-02T15:40:00+00:00","datePublished":"2022-05-02T15:40:00+00:00","description":"Introduction I started programming in C++ six years ago, starting with a few toy projects on Unreal Engine 4. I had a small experience before, having programmed in C#, Java, Python but, C++ really hooked me up for several reasons: The art of pointers The power of template metaprogramming The really big ecosystem of libraries, tools, etc And flexing about me doing C++! (but on Windows, no archlinux vim setup sorry!)","headline":"Why I switched my game engine from C++ to Rust","mainEntityOfPage":{"@type":"WebPage","@id":"https://zino2201.github.io/posts/switch-engine-rust-cpp/"},"url":"https://zino2201.github.io/posts/switch-engine-rust-cpp/"}</script><title>Why I switched my game engine from C++ to Rust | Zino</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Zino"><meta name="application-name" content="Zino"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src=" /assets/beebo.jpg " alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Zino</a></div><div class="site-subtitle font-italic">My personal blog</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/Zino2201" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/Zino2201_" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Why I switched my game engine from C++ to Rust</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Why I switched my game engine from C++ to Rust</h1><div class="post-meta text-muted"><div> By <em> <a href="https://twitter.com/Zino2201_">Zino</a> </em></div><div class="d-flex"><div> <span> Posted <em class="timeago" data-ts="1651506000" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2022-05-02 </em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2100 words"> <em>11 min</em> read</span></div></div></div><div class="post-content"><h2 id="introduction"><span class="mr-2">Introduction</span><a href="#introduction" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>I started programming in C++ six years ago, starting with a few toy projects on Unreal Engine 4. I had a small experience before, having programmed in C#, Java, Python but, C++ really hooked me up for several reasons:</p><ul><li>The art of pointers<li>The power of template metaprogramming<li>The <strong>really</strong> big ecosystem of libraries, tools, etc<li>And flexing about me doing C++! (but on Windows, no archlinux vim setup sorry!)</ul><p>Also, I really wanted to get into game engine development, I’ve made some toy projects with LWJGL (OpenGL/Vulkan bindings for Java) and SharpDX (D3D bindings for C#) on Java/C# beforehand so to me it was natural switching to C++ for that job.</p><p>With C++, I made about ~3/4 toy game engines that died off pretty quickly, I have used OpenGL, Direct3D 11, Direct3D 12 and Vulkan but I have the most experience with Direct3D11 and Vulkan (though I have now quite more experience with Vulkan).</p><h2 id="why-rust"><span class="mr-2">Why Rust?</span><a href="#why-rust" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>So, why Rust?</p><p>When programming my toy game engine v102 during the 2020 lockdown, I discovered “Rust”. A recent programming language, made by the folks at Mozilla, low-level, compiled. Nice. I saw alot of rustaceans praising the language for its safety, how C and C++ was bad and so unsafe blabla. I admit, at first I didn’t quite like Rust just because of a small amount of Rust fanatics, a classic “the most unexperienced people speak the louder because they need to show to people that they do Rust” (it’s the same case for C++, C and a lot of low-level languages!). It is only this year that I started doing Rust, and.. I love it!</p><p>I loved it for multiple reasons, the modern syntax, Cargo, but there’s one thing that really really cool with Rust: safety.</p><h3 id="memory-safety"><span class="mr-2">Memory safety</span><a href="#memory-safety" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>The majority of C++ developers here know how manipulating pointers and memory can result in a lot of bugs and crashes. The most obvious example is not free-ing memory allocated with <code class="language-plaintext highlighter-rouge">new</code> or <code class="language-plaintext highlighter-rouge">malloc()</code>: boom, memory leak! Well, this problem really shouldn’t exist anymore in modern C++ as we got now smart pointers: <code class="language-plaintext highlighter-rouge">std::unique_ptr</code>/<code class="language-plaintext highlighter-rouge">std::shared_ptr</code>/<code class="language-plaintext highlighter-rouge">std::weak_ptr</code>, free-ing your memory when leaving theirs scope. That’s cool, but it doesn’t resolve all memory safety problems in C++: for example it cannot null out your pointers pointing to an object that was deleted, like a garbage collector would do, you’ll get a <strong>dangling pointer</strong><sup>1</sup>.</p><h3 id="thread-safety"><span class="mr-2">Thread safety</span><a href="#thread-safety" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>Thread safety can be really hard, data races<sup>2</sup> are one of the worst type of bugs you can encounter, they can be really difficult to debug. In native C++, there is also no mechanism that protect you from them. Of course, the language standard library have <code class="language-plaintext highlighter-rouge">std::mutex</code>, <code class="language-plaintext highlighter-rouge">std::atomic</code>, … that can help you avoiding them, but you can still make errors and get data races if you forgot one or if you have a bad architecture.</p><h3 id="how-rust-try-to-protect-you"><span class="mr-2">How Rust try to protect you</span><a href="#how-rust-try-to-protect-you" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>In Rust, the compiler try to prevent most of the major memory and thread safety problems. How? With introducing strict rules in the language itself.</p><h4 id="references"><span class="mr-2">References</span><a href="#references" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4></h4><p>Like C++, Rust does have references (when you reference something you “borrow” it in Rust), being non-nullable pointers to a variable. But, unlike C++ they follow two rules:</p><ul><li>You can’t create a mutable reference while there is non-mutable references alive.<li>You can’t create mulitple mutable references to the same object, only one should exist at anytime.</ul><p>So, for example, if we try to create a mutable reference to <code class="language-plaintext highlighter-rouge">val</code>, and in the same scope/lifetime create a const one:</p><div class="language-rust highlighter-rouge"><div class="code-header"> <span data-label-text="Rust"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="k">let</span> <span class="k">mut</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>

<span class="k">let</span> <span class="k">mut</span> <span class="n">ref1</span> <span class="o">=</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">val</span><span class="p">;</span>
<span class="k">let</span> <span class="n">ref2</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">;</span>

<span class="nd">println!</span><span class="p">(</span><span class="s">"{}, {}"</span><span class="p">,</span> <span class="n">ref1</span><span class="p">,</span> <span class="n">ref2</span><span class="p">);</span>
</pre></table></code></div></div><p>We’ll get this:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre>error[E0502]: cannot borrow `val` as immutable because it is also borrowed as mutable
 --&gt; main.rs:6:17
  |
5 |     let mut ref1 = &amp;mut val;
  |                         --- mutable borrow occurs here
6 |     let ref2 = &amp;val;
  |                 ^^^ immutable borrow occurs here
...
9 | }
  | - mutable borrow ends here
</pre></table></code></div></div><p>Creating two mutable references will also not compile:</p><div class="language-rust highlighter-rouge"><div class="code-header"> <span data-label-text="Rust"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">let</span> <span class="k">mut</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>

    <span class="k">let</span> <span class="k">mut</span> <span class="n">ref1</span> <span class="o">=</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">val</span><span class="p">;</span>
    <span class="k">let</span> <span class="k">mut</span> <span class="n">ref2</span> <span class="o">=</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">val</span><span class="p">;</span>

    <span class="nd">println!</span><span class="p">(</span><span class="s">"{}, {}"</span><span class="p">,</span> <span class="n">ref1</span><span class="p">,</span> <span class="n">ref2</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre>error[E0499]: cannot borrow `val` as mutable more than once at a time
 --&gt; main.rs:6:25
  |
5 |     let mut ref1 = &amp;mut val;
  |                         --- first mutable borrow occurs here
6 |     let mut ref2 = &amp;mut val;
  |                         ^^^ second mutable borrow occurs here
...
9 | }
</pre></table></code></div></div><p>But having two non-mutable references will compile normally:</p><div class="language-rust highlighter-rouge"><div class="code-header"> <span data-label-text="Rust"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">let</span> <span class="k">mut</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>

    <span class="k">let</span> <span class="n">ref1</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">;</span>
    <span class="k">let</span> <span class="n">ref2</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">;</span>

    <span class="nd">println!</span><span class="p">(</span><span class="s">"{}, {}"</span><span class="p">,</span> <span class="n">ref1</span><span class="p">,</span> <span class="n">ref2</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>20, 20
</pre></table></code></div></div><h4 id="lifetimes"><span class="mr-2">Lifetimes</span><a href="#lifetimes" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4></h4><p>The lifetime mechanism is what is used to power the safety provided by references in Rust. They’re made so you can never in safe Rust have a dangling reference<sup>3</sup> or a data race. Stealing the example from <a href="https://doc.rust-lang.org/book/ch10-03-lifetime-syntax.html">The Rust Progamming Language</a>, we can represent lifetimes using named (with a <code class="language-plaintext highlighter-rouge">'</code> prefix) scopes:</p><div class="language-rust highlighter-rouge"><div class="code-header"> <span data-label-text="Rust"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="p">{</span>
    <span class="k">let</span> <span class="n">r</span><span class="p">;</span>                <span class="c1">// ---------+-- 'a</span>
                          <span class="c1">//          |</span>
    <span class="p">{</span>                     <span class="c1">//          |</span>
        <span class="k">let</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>        <span class="c1">// -+-- 'b  |</span>
        <span class="n">r</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">x</span><span class="p">;</span>           <span class="c1">//  |       |</span>
    <span class="p">}</span>                     <span class="c1">// -+       |</span>
                          <span class="c1">//          |</span>
    <span class="nd">println!</span><span class="p">(</span><span class="s">"r: {}"</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span> <span class="c1">//          |</span>
<span class="p">}</span>      
</pre></table></code></div></div><p>We can see that we have the lifetime <code class="language-plaintext highlighter-rouge">'a</code> that basically represents the whole lifetime of <code class="language-plaintext highlighter-rouge">r</code>. In a inner scope we create <code class="language-plaintext highlighter-rouge">x</code> having its lifetime <code class="language-plaintext highlighter-rouge">'b</code>, and we borrow <code class="language-plaintext highlighter-rouge">x</code> in <code class="language-plaintext highlighter-rouge">r</code> (<code class="language-plaintext highlighter-rouge">r</code> will become a reference). Now, compile that and…</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre>error[E0597]: `x` does not live long enough
  --&gt; main.rs:8:9
   |
7  |             r = &amp;x;     
   |                  - borrow occurs here
8  |         }                   
   |         ^ `x` dropped here while still borrowed
...
11 |     }   
   |     - borrowed value needs to live until here
</pre></table></code></div></div><p>The compiler prevented us from creating a dangling reference!</p><h4 id="fearless-concurrency"><span class="mr-2">Fearless Concurrency</span><a href="#fearless-concurrency" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4></h4><p>With Rust, the goal is to reach <a href="https://doc.rust-lang.org/book/ch16-00-concurrency.html">fearless concurrency</a>. In order to achieve that, the Rust compiler will detect cases when you’ll try to send to another thread a type that cannot be sended safely. This is enabled using language markers: the <code class="language-plaintext highlighter-rouge">Sync</code> trait and the <code class="language-plaintext highlighter-rouge">Send</code> trait.</p><p><code class="language-plaintext highlighter-rouge">Send</code> types can be moved to another thread safely, for example the type <code class="language-plaintext highlighter-rouge">Arc</code> in Rust (a atomic shared-pointer) is <code class="language-plaintext highlighter-rouge">Send</code>, but <code class="language-plaintext highlighter-rouge">Rc</code> (a non-atomic shared-pointer) is not.</p><p>So if you try for example to spawn a thread and moving a <code class="language-plaintext highlighter-rouge">Rc</code> (which is <code class="language-plaintext highlighter-rouge">!Send</code>) inside:</p><div class="language-rust highlighter-rouge"><div class="code-header"> <span data-label-text="Rust"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="k">use</span> <span class="nn">std</span><span class="p">::</span><span class="nn">rc</span><span class="p">::</span><span class="nb">Rc</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">std</span><span class="p">::</span><span class="n">thread</span><span class="p">;</span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span> 
<span class="p">{</span>
    <span class="k">let</span> <span class="k">mut</span> <span class="n">a</span> <span class="o">=</span> <span class="nn">Rc</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
    
    <span class="nn">thread</span><span class="p">::</span><span class="nf">spawn</span><span class="p">(</span><span class="k">move</span> <span class="p">||</span> <span class="p">{</span>
        <span class="nd">println!</span><span class="p">(</span><span class="s">"{}"</span><span class="p">,</span> <span class="n">a</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">}</span>
</pre></table></code></div></div><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre>error[E0277]: `Rc&lt;i32&gt;` cannot be sent between threads safely
   --&gt; src/main.rs:8:5
    |
8   |       thread::spawn(move || {
    |  _____^^^^^^^^^^^^^_-
    | |     |
    | |     `Rc&lt;i32&gt;` cannot be sent between threads safely
9   | |         println!("{}", a);
10  | |     });
    | |_____- within this `[closure@src/main.rs:8:19: 10:6]`
    |
    = help: within `[closure@src/main.rs:8:19: 10:6]`, the trait `Send` is not implemented for `Rc&lt;i32&gt;`
    = note: required because it appears within the type `[closure@src/main.rs:8:19: 10:6]`
note: required by a bound in `spawn`
</pre></table></code></div></div><p>Nice! The compiler tells us that <code class="language-plaintext highlighter-rouge">Rc&lt;i32&gt;</code> cannot be send between threads safely, and tell us why and why it is required:</p><ul><li>the trait <code class="language-plaintext highlighter-rouge">Send</code> is not implemented for <code class="language-plaintext highlighter-rouge">Rc&lt;i32&gt;</code> =&gt; Rc<i32> is `!Send`</i32><li>note: required by a bound in <code class="language-plaintext highlighter-rouge">spawn</code> =&gt; Tells us that <code class="language-plaintext highlighter-rouge">spawn</code> requires that the closure is <code class="language-plaintext highlighter-rouge">Send</code>.</ul><p>The <code class="language-plaintext highlighter-rouge">Sync</code> trait tells Rust that you can have references to your type in multiple threads without problems. This is typically enabled by using a <code class="language-plaintext highlighter-rouge">Mutex</code>, <code class="language-plaintext highlighter-rouge">RwLock</code>, etc.</p><p>So, we saw that Rust implements by default a lot of safety about memory and threads, using rules &amp; semantics implemented in the language directly we can greatly increase the safety of our code without much headache (a bit though when learning Rust haha). You may achieve the same sort of protection in C++ using external tools (like sanitizers), but having that inside the language directly is a great advantage.</p><h4 id="unsafe-code-in-rust"><span class="mr-2">Unsafe code in Rust</span><a href="#unsafe-code-in-rust" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4></h4><p>I’m not going to talk much about unsafe code in Rust, but yes, you can write unsafe code in Rust. This is required for implementing safe types or for FFI: <a href="https://doc.rust-lang.org/book/ch19-01-unsafe-rust.html">Unsafe Rust</a></p><h3 id="cargo"><span class="mr-2">Cargo</span><a href="#cargo" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>Coming from C++, Cargo is a gift from god, really. I really forgot what was a great package manager thanks to C++. It is really easy to setup, configure and the amount of crates there already are is really cool! Bye CMake + vcpkg!</p><h2 id="state-of-game-engine-development-in-rust"><span class="mr-2">State of game engine development in Rust</span><a href="#state-of-game-engine-development-in-rust" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>Now, let’s talk about game engine development.</p><p>As we saw before, Rust have some great advantages compared to C++, and for many (including me) it can be a serious competitor to C++ in the gamedev world. As game and game engines because more and more complex and multithreaded, the need for more safety is increasing, even more for thread safety where it can really get complicated.</p><p>Browsing <a href="https://crates.io/">crates.io</a> shows that there is quite a lot of crates dedicated to gamedev and game engine dev. My game engine has a primary Vulkan backend, so naturally I looked for Vulkan crates and found two interesting ones:</p><ul><li><code class="language-plaintext highlighter-rouge">vulkano</code>: a high-level safe wrapper around Vulkan, great if you don’t want to handle all the most annoying things you need for Vulkan like managing the memory<li><code class="language-plaintext highlighter-rouge">ash</code>: unsafe bindings for Vulkan. That’s what I choose.</ul><p>Using <code class="language-plaintext highlighter-rouge">ash</code> was really simple, it even provides some helper things like builder types so you can easily create the big Vulkan structures:</p><div class="language-rust highlighter-rouge"><div class="code-header"> <span data-label-text="Rust"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="k">let</span> <span class="n">depth_stencil_state</span> <span class="o">=</span> <span class="nn">vk</span><span class="p">::</span><span class="nn">PipelineDepthStencilStateCreateInfo</span><span class="p">::</span><span class="nf">builder</span><span class="p">()</span>
        <span class="nf">.depth_test_enable</span><span class="p">(</span><span class="n">info</span><span class="py">.depth_stencil_state.enable_depth_test</span><span class="p">)</span>
        <span class="nf">.depth_write_enable</span><span class="p">(</span><span class="n">info</span><span class="py">.depth_stencil_state.enable_depth_write</span><span class="p">)</span>
        <span class="nf">.depth_compare_op</span><span class="p">(</span><span class="nf">convert_compare_op</span><span class="p">(</span><span class="n">info</span><span class="py">.depth_stencil_state.depth_compare_op</span><span class="p">))</span>
        <span class="nf">.depth_bounds_test_enable</span><span class="p">(</span><span class="n">info</span><span class="py">.depth_stencil_state.enable_depth_bounds_test</span><span class="p">)</span>
        <span class="nf">.stencil_test_enable</span><span class="p">(</span><span class="n">info</span><span class="py">.depth_stencil_state.enable_stencil_test</span><span class="p">)</span>
        <span class="nf">.front</span><span class="p">(</span><span class="nf">convert_stencil_op_state</span><span class="p">(</span><span class="n">info</span><span class="py">.depth_stencil_state.front_face</span><span class="p">))</span>
        <span class="nf">.back</span><span class="p">(</span><span class="nf">convert_stencil_op_state</span><span class="p">(</span><span class="n">info</span><span class="py">.depth_stencil_state.back_face</span><span class="p">))</span>
        <span class="nf">.min_depth_bounds</span><span class="p">(</span><span class="n">info</span><span class="py">.depth_stencil_state.min_depth_bounds</span><span class="p">)</span>
        <span class="nf">.max_depth_bounds</span><span class="p">(</span><span class="n">info</span><span class="py">.depth_stencil_state.max_depth_bounds</span><span class="p">)</span>
</pre></table></code></div></div><p>For window management, you have crates for SDL2 and GLFW, the most used libraries for that. I personally used the <code class="language-plaintext highlighter-rouge">winapi</code> crate to interface with the Windows API as in my C++ game engine I don’t use any library because I wanted to experiment with managing that myself (and for now it went great, but I still haven’t ported my engine to X11/Wayland).</p><p>With those two crates (and some other misc things but not related to game engine developement whatsoever) I started re-re-writing my engine but this time in Rust! And it went… really great!</p><p>Understanding lifetimes, borrowing took me about one week, it was quite hard at the beginning, because in my Vulkan backend in my C++ engine, each device resource has a reference to the device, which is well logical, but building something like that in Rust is hard, because you need to introduce explicit lifetimes when you store references in Rust, so the compiler know that the reference will not outlive what it points to, but.. my device was created and stored in a <code class="language-plaintext highlighter-rouge">Box</code> (<code class="language-plaintext highlighter-rouge">std::unique_ptr</code> equivalent) and it is the device that created the resource and they are also stored inside a <code class="language-plaintext highlighter-rouge">Box</code>, the compiler complained that the reference may outlive the device, and well it was quite true, I could drop the device and boom, crash. So I accepted that this was a design flaw, but I really didn’t have other solutions, so… I wrote unsafe Rust! (just raw pointers). It works, I think now after a month of developing this Rust engine I should’ve went with shared pointers, but whatever it works :p</p><h2 id="conclusion"><span class="mr-2">Conclusion</span><a href="#conclusion" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>I really like Rust, it seriously is refreshing after doing many years of C++, and I really think that in the coming years/decades Rust will be more and more used in the game industry as its safety features are really a big plus. As more and more game engines use multiple threads, I think investing your resources in using Rust may be really interesting.</p><p>I think I’ll doing some updates soon about my game engine, maybe I will abandon Rust and go back to C++, who know?</p><p>I hope you liked this post, it is my first one so it may be poorly written, and as english is not my first language it can complicate comprehension, but I hope it has been clear!</p><hr /><ol><li>A pointer pointing to an invalid memory location (that was freed for example).<li>Happens when a thread try to write to a shared resource while another thread read from it.<li>Same as a dangling pointer.</ol><div id="disqus_thread"></div><script> var disqus_config = function () { this.page.url = "https://zino2201.github.io/posts/switch-engine-rust-cpp/"; this.page.identifier = "/posts/switch-engine-rust-cpp"; }; (function() { var d = document, s = d.createElement('script'); s.src = 'https://zino2201.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); </script> <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/rust/'>rust</a>, <a href='/categories/c/'>c++</a>, <a href='/categories/game-engine/'>game engine</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Why I switched my game engine from C++ to Rust - Zino&amp;url=https://zino2201.github.io/posts/switch-engine-rust-cpp/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Why I switched my game engine from C++ to Rust - Zino&amp;u=https://zino2201.github.io/posts/switch-engine-rust-cpp/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https://zino2201.github.io/posts/switch-engine-rust-cpp/&amp;text=Why I switched my game engine from C++ to Rust - Zino" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div class="post-navigation d-flex justify-content-between"> <span class="btn btn-outline-primary disabled" prompt="Older"><p>-</p></span> <span class="btn btn-outline-primary disabled" prompt="Newer"><p>-</p></span></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://twitter.com/Zino2201_">Zino</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
